name: Release Build

on:
    push:
        tags:
            - "v*"

permissions:
    contents: write
    id-token: write
    attestations: write

jobs:
    release:
        name: Build and Release
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, windows-latest, macos-latest, macos-14]

        steps:
            - uses: actions/checkout@v4

            - name: Set up LLVM (Linux)
              if: matrix.os == 'ubuntu-latest'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y llvm-dev clang ninja-build

            - name: Set up LLVM (macOS)
              if: startsWith(matrix.os, 'macos-')
              run: |
                  brew install llvm ninja
                  echo "LLVM_DIR=$(brew --prefix llvm)/lib/cmake/llvm" >> $GITHUB_ENV
                  echo "$(brew --prefix llvm)/bin" >> $GITHUB_PATH

            - uses: msys2/setup-msys2@v2
              if: matrix.os == 'windows-latest'
              with:
                  msystem: UCRT64
                  update: true
                  install: >-
                      git
                      mingw-w64-ucrt-x86_64-toolchain
                      mingw-w64-ucrt-x86_64-cmake
                      mingw-w64-ucrt-x86_64-ninja
                      mingw-w64-ucrt-x86_64-llvm
                      mingw-w64-ucrt-x86_64-nsis

            - name: Configure and Build (Windows)
              if: matrix.os == 'windows-latest'
              shell: msys2 {0}
              run: |
                  cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
                  cmake --build build

            - name: Configure and Build (macOS)
              if: startsWith(matrix.os, 'macos-')
              run: |
                  cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
                  cmake --build build

            - name: Configure and Build (Linux)
              if: matrix.os == 'ubuntu-latest'
              run: |
                  cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++
                  cmake --build build

            - name: Package (Windows)
              if: matrix.os == 'windows-latest'
              shell: msys2 {0}
              run: |
                  cd build
                  cpack -C Release

            - name: Package (Unix)
              if: matrix.os != 'windows-latest'
              run: |
                  cd build
                  cpack -C Release

            - name: Build VS Code Extension
              if: matrix.os == 'ubuntu-latest'
              run: |
                  cd editors/vscode
                  npm install
                  npx vsce package

            - name: Create Release
              uses: softprops/action-gh-release@v2
              if: startsWith(github.ref, 'refs/tags/')
              with:
                  files: |
                      build/FluxCompiler-*
                      editors/vscode/*.vsix
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Attest Build Provenance
              uses: actions/attest-build-provenance@v2
              if: startsWith(github.ref, 'refs/tags/')
              with:
                  subject-path: "build/FluxCompiler-*"
